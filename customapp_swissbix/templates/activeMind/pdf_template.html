{% load static %}
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActiveMind - Servizi di Supporto Sistemistico</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
            background-image: url("{% static 'images/cover.png' %}");
            background-repeat: no-repeat;
            background-position: center center;
            background-size: contain;
        }
        @page normal {
            size: A4;
            margin: 1.5cm;
            background-image: url("{% static 'images/background.png' %}");
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.2;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .cover {
            text-align: center;
            padding-top: 200px;
            margin-left: 400px;
        }

        .cover-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 40px;
        }

        .cover-client {
            margin-top: 40px;
            font-size: 16px;
        }

        .cover-logo {
            margin-top: 150px;
            font-size: 26px;
            font-weight: bold;
        }

        .cover-logo span {
            color: #dc2626;
        }
        
        .header {
            text-align: left;
            margin-bottom: 15px;
            padding-bottom: 8px;
        }
        
        .company-info {
            font-size: 12px;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.1;
        }
        
        .client-info {
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .client-info h3 {
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .document-title {
            color: #dc2626;
            font-size: 30px;
            font-weight: bold;
            margin: 40px 0 30px 0;
            text-align: center;
        }
        
        .intro-text {
            font-size: 16px;
            line-height: 1.4;
            margin-bottom: 20px;
            text-align: justify;
        }
        
        .section {
            margin-bottom: 15px;
        }
        
        .section-title {
            background-color: #dc2626;
            color: white;
            padding: 6px 10px;
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        .service-item {
            margin-bottom: 0px;
            padding: 0px;
        }
        
        .service-header {
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 0px;
            margin-top: 20px;
            font-size: 18px;
        }
        
        .service-details {
            margin-left: 10px;
            font-size: 16px;
        }

        .service-details ul {
            margin: 0px 0;
            padding-left: 15px;
        }
        
        .service-details li {
            margin-bottom: 4px;
            font-size: 14px;
        }

        .service-details p {
            margin: 0px 0;
            font-size: 14px;
            padding-left: 15px
        }
        
        .pricing-table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 14px;
        }
        
        .pricing-table th,
        .pricing-table td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: left;
        }
        
        .pricing-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        .pricing-table .price {
            text-align: right;
            font-weight: bold;
        }
        
        .total-section {
            padding: 15px;
            margin: 25px 0;
        }

        .total-section-title {
            color: #dc2626; 
            margin-bottom: 20px; 
            font-size: 20px;
            background-color: #f8f8f8;
            border: 2px solid #dc2626;
        }
        
        .grand-total {
            font-size: 20px;
            font-weight: bold;
            color: #dc2626;
            border-top: 2px solid #dc2626;
            padding-top: 8px;
        }
        
        .signature-section {
            margin-top: 0px;
        }

        .signature-section p {
            margin-top: 60px;
        }
        
        .signature-row {
            display: flex;
            justify-content: space-between;
            margin-top: 0px;
        }
        
        .signature-box {
            width: 45%;
            text-align: left;
            border-bottom: 1px solid #333;
            padding-bottom: 50px;
            margin-left: 400px;
            font-size: 16px;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        .conditions {
            font-size: 16px;
            margin-top: 25px;
            line-height: 1.3;
        }
        
        .conditions h4 {
            color: #dc2626;
            margin-bottom: 8px;
            font-size: 20px;
        }
        
        .conditions ul {
            margin: 5px 0;
            padding-left: 15px;
        }
        
        .conditions li {
            margin-bottom: 2px;
        }
        
        .service-title {
            font-weight: bold;
            {% comment %} color: #dc2626; {% endcomment %}
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- COPERTINA -->
    <div class="cover">
        <div class="cover-title">
            Intervento sistemistico programmato <span style="color:#dc2626;">ActiveMind</span>
        </div>
        <div class="cover-client">
            <strong>{{ client_info.nome }}</strong><br><br><br>
            {{ client_info.indirizzo }}<br><br><br><br><br><br><br><br>
            Massagno, {{ date }}
        </div>
    </div>

    <pdf:nexttemplate name="normal" />

    {% if offer_data.tiers %}
    <div class="section page-break">
        <div class="section-title">Sezione 1.0</div>
        <div class="service-item">
            <p class="service-header">System Assurance tramite RMM di sistema (intervento propedeutico)</p>
            <div class="service-details">
                <h3><strong>Implementazione degli agent RMM (Remote Monitoring and Management)</strong></h3>
                <table class="pricing-table">
                    <tr>
                        <th colspan="2">System Assurance</th>
                        <th>Qt.</th>
                        <th>Prezzo unitario</th>
                    </tr>
                    {% for tier in offer_data.tiers %}
                        {% if tier.selected %}
                        <tr>
                            <td colspan="2">
                                - Installazione agent RMM (1 mese)<br>
                                - Avvio e riesamina dello stato dei PC<br>
                                - Generazione di un Asset managed (inventario)<br>
                                - Verifica infrastruttura informatica<br>
                                - Device networking<br>
                                - Nas/storage<br>
                                - Switch/router<br>
                                - Reportistica sull'infrastruttura informatica
                            </td>
                            <td>1</td>
                            <td class="price">CHF {{ tier.price|default:"0.00"|floatformat:2 }}.-</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </table>
                <br>
                <p style="margin: 10px 0;">Il servizio permette di:</p>
                <ul>
                    <li>Fotografare lo "stato dell'arte" dell'infrastruttura del cliente</li>
                    <li>Generare un inventario (asset managed) dei client presenti in azienda</li>
                    <li>Verificare gli aggiornamenti di windows e pianificarne l'avvio (da integrare nel servizio ActiveMind)</li>
                    <li>Definire tempistiche e valori economici di intervento da applicare al contratto</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    {% if section2_products_pages %}
        {% for page in section2_products_pages %}
            <div class="page-break">
                {% if forloop.first %}
                    <div class="section-title">Sezione 2.0 - Prodotti Ricorrenti</div>
                    <div class="service-header">Licenze e Prodotti (Costi Mensili o Annuali):</div>
                {% endif %}
                {% for product in page %}
                    <div class="service-item">
                        <h1 class="service-title" style="margin-top: 15px;">
                            {{ product.title }}
                            <span style="font-weight: normal; font-size: 13px; color: #555;">
                                {% if product.billingType == 'yearly' %}(Fatt. Annuale){% else %}(Fatt. Mensile){% endif %}
                            </span>
                        </h1>
                        <table class="pricing-table">
                            <tr>
                                <th>Costo unitario</th>
                                <th>Quantità</th>
                                <th>Costo totale</th>
                            </tr>
                            <tr>
                                <td>CHF {{ product.unitPrice|default:"0.00"|floatformat:2 }}.-</td>
                                <td>{{ product.quantity }}</td>
                                <td class="price">CHF {{ product.total|default:"0.00"|floatformat:2 }}.-</td>
                            </tr>
                        </table>
                        {% if product.features %}
                        <div class="service-details">
                            <ul>
                                {% for feature in product.features %}
                                    <li>{{ feature }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    <hr style="border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
                {% endfor %}
            </div>
        {% endfor %}
    {% endif %}

    {% if section2_services_pages %}
        {% for page in section2_services_pages %}
            <div class="page-break">
                {% if forloop.first %}
                    <div class="section-title">Sezione 2.1</div>
                    <div class="service-header">Servizi inclusi in ActiveMind:</div>
                {% endif %}
                {% for service in page %}
                    <div class="service-item">
                        <h1 class="service-title">{{ service.title }}</h1>
                        <table class="pricing-table">
                            <tr>
                                <th>Costo unitario</th>
                                <th>Quantità</th>
                                <th>Costo totale</th>
                            </tr>
                            <tr>
                                <td>CHF {{ service.unitPrice|default:"0.00"|floatformat:2 }}.-</td>
                                <td>{{ service.quantity }}</td>
                                <td class="price">CHF {{ service.total|default:"0.00"|floatformat:2 }}.-</td>
                            </tr>
                        </table>
                        {% if service.features %}
                        <div class="service-details">
                            <ul>
                                {% for feature in service.features %}
                                    <li>{{ feature }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    <hr>
                {% endfor %}
            </div>
        {% endfor %}
    {% endif %}

    {% if offer_data.frequencies %}
    <div class="section page-break">
        <div class="section-title">Sezione 3.0</div>
        <div class="service-item">
            <div class="service-header">Condizioni incluse in ActiveMind:</div>
            <div class="service-details">
                {% for freq in offer_data.frequencies %}
                    {% if freq.selected %}
                        <h3><strong>Pianificazione intervento</strong></h3>
                        <p><strong>{{ freq.label }}</strong> programmato anticipatamente</p>
                        <br>
                        <h3><strong>Intervento in loco programmato</strong></h3>
                        <ul>
                            <li>Pianificazione ed intervento sull'asset managed dell'uscita precedente</li>
                            <li>L'intervento implica la presenza e l'accesso ai device sotto contratto</li>
                            <li>Eventuali modifiche da parte del cliente devono essere prontamente comunicate (previa modifica contrattuale in corso)</li>
                            <li>Il valore economico copre prettamente gli interventi programmati</li>
                            <li>Gli interventi a regia saranno fatturati secondo accordi a latere</li>
                            <li>L'intervento programmato verrà confermato 3gg prima dell'uscita per evitare incomprensioni</li>
                            <li>Verrà redatto un rapporto completo sullo stato dell'intervento eseguito</li>
                            <li>Seguirà uscita del referente commerciale per un confronto con il cliente sull'operato</li>
                            <li>Gli interventi sui 3/6/12 mesi includeranno possibilmente i mesi di chiusura o di festività per evitare il più possibile disservizi</li>
                        </ul>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- RIEPILOGO ECONOMICO -->
    <div class="total-section page-break">
        <h1 class="total-section-title">Definizione Economica</h1>
        <table class="pricing-table">
            <tr>
                <th>Descrizione</th>
                <th>Quantità</th>
                <th>Prezzo unitario</th>
                <th>Prezzo totale</th>
            </tr>

            {% for tier in offer_data.tiers %}
                {% if tier.selected %}
                <tr>
                    <td>{{ tier.label }}</td>
                    <td>1</td>
                    <td class="price">CHF {{ tier.price|default:"0.00"|floatformat:2 }}.-</td>
                    <td class="price">CHF {{ tier.total|default:"0.00"|floatformat:2 }}.-</td>
                </tr>
                {% endif %}
            {% endfor %}

            {% for product in section2_products %}
                {% if product.quantity > 0 %}
                <tr>
                    <td>
                        {{ product.title }}
                        {% if product.billingType == 'yearly' %}
                            <span style="font-size: 10px; color: #555;">(Fatt. Annuale)</span>
                        {% else %}
                            <span style="font-size: 10px; color: #555;">(Fatt. Mensile)</span>
                        {% endif %}
                    </td>
                    <td>{{ product.quantity }}</td>
                    <td class="price">CHF {{ product.unitPrice|default:"0.00"|floatformat:2 }}.-</td>
                    <td class="price">CHF {{ product.total|default:"0.00"|floatformat:2 }}.-</td>
                </tr>
                {% endif %}
            {% endfor %}

            {% for service in offer_data.services %}
                {% if service.quantity > 0 %}
                <tr style="border-top: 1px dashed #ccc;">
                    <td>{{ service.title }} (Base Intervento)</td>
                    <td>{{ service.quantity }}</td>
                    <td class="price">CHF {{ service.unitPrice|default:"0.00"|floatformat:2 }}.-</td>
                    <td class="price">CHF {{ service.total|default:"0.00"|floatformat:2 }}.-</td>
                </tr>
                {% endif %}
            {% endfor %}

            {% if offer_data.totals.monthly > 0 %}
            <tr style="background-color: #f8f8f8; font-weight: bold;">
                <td colspan="3">SUBTOTALE MENSILE (ricorrente)</td>
                <td class="price">CHF {{ offer_data.totals.monthly|floatformat:2 }}</td>
            </tr>
            {% endif %}

            {% if offer_data.totals.quarterly > 0 %}
            <tr style="background-color: #f8f8f8; font-weight: bold;">
                <td colspan="3">SUBTOTALE TRIMESTRALE (ricorrente)</td>
                <td class="price">CHF {{ offer_data.totals.quarterly|floatformat:2 }}</td>
            </tr>
            {% endif %}

            {% if offer_data.totals.biannual > 0 %}
            <tr style="background-color: #f8f8f8; font-weight: bold;">
                <td colspan="3">SUBTOTALE SEMESTRALE (ricorrente)</td>
                <td class="price">CHF {{ offer_data.totals.biannual|floatformat:2 }}</td>
            </tr>
            {% endif %}

            {% if offer_data.totals.yearly > 0 %}
            <tr style="background-color: #f8f8f8; font-weight: bold;">
                <td colspan="3">SUBTOTALE ANNUALE (ricorrente)</td>
                <td class="price">CHF {{ offer_data.totals.yearly|floatformat:2 }}</td>
            </tr>
            {% endif %}

            <tr style="background-color: #dc2626; color: white; font-weight: bold;">
                <td colspan="3">TOTALE COMPLESSIVO</td>
                <td class="price">CHF {{ offer_data.totals.grand_total|floatformat:2 }}</td>
            </tr>
        </table>
    </div>


    <!-- CONDIZIONI CONTRATTUALI HARDCODED (ripristinate) -->
    <div class="conditions page-break">
        <h4>Condizioni contrattuali di vendita</h4>
        <p><strong>Contatti per Assistenza Tecnica:</strong></p>
        <ul>
            <li>Apertura ticket: helpdesk@swissbix.ch</li>
            <li>Supporto telefonico: 091 960 22 09</li>
            <li>Orari supporto tecnico: dal lunedì al venerdì dalle 9:00 alle 12:00 e dalle 14:00 alle 17:00</li>
        </ul>
        <p><strong>Metodo di pagamento e fatturazione:</strong></p>
        <p>Fatturazione ad intervento eseguito, pagamento a 20gg</p>
        <p><strong>Condizioni generali:</strong></p>
        <ul>
            <li>Condizioni generali di vendita visionabili al link: https://www.swissbix.ch/cgv.pdf</li>
            <li>I prezzi indicati sono IVA Esclusa</li>
            <li>Offerta valida fino al {{ limit_acceptance_date }}</li>
        </ul>
    </div>

    <!-- FIRMA DIGITALE (ripristinata) -->
    <div class="signature-section">
        <p>Massagno, __________________</p>
        <div class="signature-row">
            <div class="signature-box" style="border-bottom: none; padding-bottom: 0; margin-left: 0;">
                <strong>Mauro Gallani</strong><br>
                Swissbix SA
            </div>
            {% if digital_signature_url %}
                <div class="signature-box" style="border-bottom: none; padding-bottom: 0;">
                    <strong>Per Accettazione</strong><br><br>
                    <img src="{% static digital_signature_url %}" alt="Firma Digitale" style="max-width: 100%; width: 250px; height: auto;">
                    <br>
                    {{ nameSignature }}
                </div>
            {% else %}
                <div class="signature-box">
                    <strong>Per Accettazione</strong><br>
                    {{ nameSignature }}
                </div>
            {% endif %}
        </div>
    </div>
</body>
</html>
